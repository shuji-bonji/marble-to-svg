var W=Object.defineProperty;var P=(r,e,t)=>e in r?W(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var d=(r,e,t)=>P(r,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();var c=(r=>(r.NEXT="N",r.COMPLETE="C",r.ERROR="E",r))(c||{}),m=(r=>(r.SUBSCRIBE="S",r.UNSUBSCRIBE="U",r))(m||{});const l={FRAME:"-",COMPLETE:"|",ERROR:"#",GROUP_START:"(",GROUP_END:")",SUBSCRIBE:"^",UNSUBSCRIBE:"!"},O={width:800,height:60,margin:{top:20,right:30,bottom:10,left:30},timeline:{strokeWidth:2,stroke:"#999",tickLength:5},markers:{radius:15,stroke:"#555",strokeWidth:1.5,fill:"#fff",textFill:"#333",fontSize:12},complete:{stroke:"#555",strokeWidth:2,height:30},error:{stroke:"#d44",strokeWidth:2,size:15},subscription:{stroke:"#080",strokeWidth:1.5,height:25},frameWidth:30},C={VALUE_CHAR:/^[0-9a-zA-Z]$/,SPACE:/^\s$/};function L(r,e={}){const{values:t={},error:n=new Error("Marble Error"),includeSubscription:s=!0}=e,o=F(r,s);return V(o,t,n)}const F=(r,e)=>{const t=[];let n=0,s=!1,o=[];for(const i of r)if(!C.SPACE.test(i))switch(i){case l.GROUP_START:s=!0,o=[];break;case l.GROUP_END:s=!1,o.length>0&&(w(t,n),t[n].values.push(...o)),n++;break;case l.FRAME:s||n++;break;case l.COMPLETE:case l.ERROR:case l.SUBSCRIBE:case l.UNSUBSCRIBE:w(t,n),i===l.COMPLETE&&(t[n].complete=!0),i===l.ERROR&&(t[n].error=!0),i===l.SUBSCRIBE&&e&&(t[n].subscribe=!0),i===l.UNSUBSCRIBE&&e&&(t[n].unsubscribe=!0),s||n++;break;default:if(C.VALUE_CHAR.test(i))s?o.push(i):(w(t,n),t[n].values.push(i),n++);else throw new Error(`Invalid character "${i}" at position ${r.indexOf(i)}`)}return t},w=(r,e)=>{r[e]||(r[e]={index:e,values:[],complete:!1,error:!1})},V=(r,e,t)=>{const n=[];return r.forEach(({index:s,values:o,complete:i,error:$,subscribe:b,unsubscribe:S})=>{o.forEach(E=>{const p=E in e?e[E]:E;n.push({frame:s,notification:R(c.NEXT,p)})}),i&&n.push({frame:s,notification:R(c.COMPLETE)}),$&&n.push({frame:s,notification:R(c.ERROR,void 0,t)}),b&&n.push({frame:s,notification:B(m.SUBSCRIBE)}),S&&n.push({frame:s,notification:B(m.UNSUBSCRIBE)})}),n};function R(r,e,t){switch(r){case c.NEXT:return{kind:r,value:e};case c.COMPLETE:return{kind:r};case c.ERROR:return{kind:r,error:t}}}const B=r=>({kind:r,value:r==="S"?"subscribe":"unsubscribe"});function z(r,e,t){let n="";return n+=`<line x1="${r}" y1="${e-t.height/2}" x2="${r}" y2="${e+t.height/2}" stroke="${t.stroke}" stroke-width="${t.strokeWidth}" />`,n+=`<path d="M ${r-5} ${e-t.height/2} L ${r} ${e-t.height/2-5} L ${r+5} ${e-t.height/2} Z" fill="${t.stroke}" />`,n}function H(r,e,t){let n="";const s=t.size;return n+=`<line x1="${r}" y1="${e-s/2}" x2="${r}" y2="${e+s/2}" stroke="${t.stroke}" stroke-width="${t.strokeWidth}" />`,n+=`<path d="M ${r-s/2} ${e-s/2} L ${r+s/2} ${e+s/2} M ${r-s/2} ${e+s/2} L ${r+s/2} ${e-s/2}" stroke="${t.stroke}" stroke-width="${t.strokeWidth}" />`,n}function _(r,e,t,n){let s="";const o=String(n.value!==void 0?n.value:"");return s+=`<circle cx="${r}" cy="${e}" r="${t.radius}" fill="${t.fill}" stroke="${t.stroke}" stroke-width="${t.strokeWidth}" />`,s+=`<text x="${r}" y="${e+t.fontSize/3}" text-anchor="middle" font-size="${t.fontSize}" fill="${t.textFill}">${X(o)}</text>`,s}function G(r,e,t){let n="";return n+=`<line x1="${r}" y1="${e-t.height/2}" x2="${r}" y2="${e+t.height/2}" stroke="${t.stroke}" stroke-width="${t.strokeWidth}" stroke-dasharray="3,1" />`,n+=`<text x="${r+2}" y="${e-t.height/2-5}" font-size="10" fill="${t.stroke}">subscribe</text>`,n}function D(r,e,t){let n="";return n+=`<line x1="${r}" y1="${e-t.height/2}" x2="${r}" y2="${e+t.height/2}" stroke="${t.stroke}" stroke-width="${t.strokeWidth}" stroke-dasharray="2,1" />`,n+=`<text x="${r+2}" y="${e-t.height/2-5}" font-size="10" fill="${t.stroke}">unsubscribe</text>`,n}function U(r,e){const t=N(O,e),{width:n,height:s,margin:o,timeline:i,markers:$,complete:b,error:S,subscription:E,frameWidth:p}=t,M=t.width-(t.margin.left+t.margin.right),T=t.height-(t.margin.top+t.margin.bottom),y=Math.max(...r.map(a=>a.frame),0),g=a=>o.left+a*p;let u=`<svg xmlns="http://www.w3.org/2000/svg" width="${n}" height="${s}" viewBox="0 0 ${n} ${s}">`;const h=o.top+T/2;u+=`<line x1="${o.left}" y1="${h}" x2="${o.left+Math.min(M,(y+1)*p)}" y2="${h}" stroke="${i.stroke}" stroke-width="${i.strokeWidth}" />`;for(let a=0;a<=y+1;a++){const f=g(a);u+=`<line x1="${f}" y1="${h-i.tickLength}" x2="${f}" y2="${h+i.tickLength}" stroke="${i.stroke}" stroke-width="${i.strokeWidth}" />`}const I=r.filter(a=>a.notification.kind===m.SUBSCRIBE),A=r.filter(a=>a.notification.kind===m.UNSUBSCRIBE);return I.forEach(a=>{const f=g(a.frame);u+=G(f,h,E)}),A.forEach(a=>{const f=g(a.frame);u+=D(f,h,E)}),r.forEach(a=>{const{frame:f,notification:v}=a,k=g(f);if(v.kind===c.COMPLETE){u+=z(k,h,b);return}if(v.kind===c.ERROR){u+=H(k,h,S);return}v.kind===c.NEXT&&(u+=_(k,h,$,v))}),u+="</svg>",u}function X(r){return r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function N(r,e){if(!e)return r;const t={...r};for(const n in e)e[n]&&typeof e[n]=="object"&&!Array.isArray(e[n])?t[n]=N(r[n],e[n]):t[n]=e[n];return t}class x{constructor(e,t={}){d(this,"container");d(this,"inputElement");d(this,"valuesElement");d(this,"renderButton");d(this,"svgContainer");d(this,"downloadButton");d(this,"renderOptions");d(this,"lastSvg","");const n=document.getElementById(e);if(!n)throw new Error(`Container element with id '${e}' not found`);this.container=n,this.renderOptions=t,this.createUI(),this.bindEvents()}createUI(){this.container.innerHTML="";const e=document.createElement("div");e.className="marble-form";const t=document.createElement("label");t.textContent="マーブル記法：",t.htmlFor="marble-input",this.inputElement=document.createElement("textarea"),this.inputElement.id="marble-input",this.inputElement.rows=3,this.inputElement.placeholder="例: ---a---b---|";const n=document.createElement("label");n.textContent="値のマッピング（JSON形式）：",n.htmlFor="values-input",this.valuesElement=document.createElement("textarea"),this.valuesElement.id="values-input",this.valuesElement.rows=3,this.valuesElement.placeholder='例: { "a": "Hello", "b": "World" }',this.renderButton=document.createElement("button"),this.renderButton.textContent="SVG生成",this.renderButton.className="render-button",this.svgContainer=document.createElement("div"),this.svgContainer.className="svg-container",this.downloadButton=document.createElement("button"),this.downloadButton.textContent="SVGをダウンロード",this.downloadButton.className="download-button",this.downloadButton.style.display="none",e.appendChild(t),e.appendChild(this.inputElement),e.appendChild(n),e.appendChild(this.valuesElement),e.appendChild(this.renderButton),this.container.appendChild(e),this.container.appendChild(this.svgContainer),this.container.appendChild(this.downloadButton)}bindEvents(){this.renderButton.addEventListener("click",()=>{this.render()}),this.inputElement.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.render())}),this.downloadButton.addEventListener("click",()=>{this.downloadSvg()})}parseInput(){const e=this.inputElement.value.trim();if(!e)return this.showError("マーブル記法を入力してください"),null;let t={};const n=this.valuesElement.value.trim();if(n)try{t=JSON.parse(n)}catch{return this.showError("値のマッピングが不正なJSON形式です"),null}return{events:L(e,{values:t,includeSubscription:!0})}}generateSvg(e){const t=U(e,this.renderOptions);return this.lastSvg=t,t}updateUi(e){this.svgContainer.innerHTML=e,this.showSuccess(),this.downloadButton.style.display="block"}render(){const e=this.parseInput();if(!e)return;const t=this.generateSvg(e.events);this.updateUi(t)}downloadSvg(){if(!this.lastSvg)return;const e=new Blob([this.lastSvg],{type:"image/svg+xml"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="marble-diagram.svg",n.click(),setTimeout(()=>{URL.revokeObjectURL(t)},100)}showError(e){this.svgContainer.innerHTML=`<div class="error-message">${e}</div>`,this.downloadButton.style.display="none"}showSuccess(){const e=this.svgContainer.querySelector(".error-message");e&&e.remove()}setValues(e,t={}){this.inputElement.value=e,this.valuesElement.value=JSON.stringify(t,null,2),this.render()}}window.MarbleTools={parseMarble:L,renderSVG:U,MarbleViewer:x};document.addEventListener("DOMContentLoaded",()=>{const r=new x("marble-viewer-container",O),e=document.getElementById("example-selector"),t={basic:{marble:"---a---b---|",values:{a:"Hello",b:"World"}},error:{marble:"---a---b---#",values:{a:1,b:2}},group:{marble:"---(abc)---|",values:{a:1,b:2,c:3}},hot:{marble:"-a-^-b---c---|",values:{a:"ignored",b:"Hello",c:"World"}},unsubscribe:{marble:"-a-^-b---c---!---|",values:{a:"ignored",b:"Hello",c:"World"}},complex:{marble:"---(abc)---(def)---|",values:{a:1,b:2,c:3,d:4,e:5,f:6}}};e.addEventListener("change",()=>{const n=e.value;if(n in t){const s=t[n];r.setValues(s.marble,s.values),r.render()}}),r.setValues(t.basic.marble,t.basic.values),r.render()});
//# sourceMappingURL=index-C82bb7n7.js.map
